<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Burgundy - Download</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 0; 
        padding: 0; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        background: radial-gradient(circle at center, #d0d0d0 0%, #1c1c1c 100%);
    }
    .container { 
        background-color: #800020; 
        padding: 30px; 
        border-radius: 20px;
        text-align: center; 
        width: 90%; 
        max-width: 400px; 
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        position: relative;
    }
    h2 { 
        margin-bottom: 5px; 
        font-size: 24px;
    }
    input[type="text"] { 
        width: 100%; 
        padding: 12px; 
        border-radius: 8px; 
        border: 1px solid #ccc; 
        font-size: 16px; 
        box-sizing: border-box; 
    }

    .btn {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 80%;          
        max-width: 300px;
        padding: 12px;
        font-size: 16px;
        border-radius: 10px;
        border: 1px solid white;
        background-color: #2c2c2c; 
        color: white; 
        cursor: pointer; 
        text-decoration: none;
        font-weight: bold; 
        box-sizing: border-box; 
        transition: background-color 0.2s ease;
        text-align: center;
        position: relative;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn:hover:not(:disabled) { 
        background-color: #444444; 
    }

    form {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }

    form input[type="submit"] {
        margin-top: 5px; 
        width: 80%;
        max-width: 300px;
        align-self: center;
    }

    /* Spinner inside button */
    .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
        vertical-align: middle;
        display: none; /* hidden by default */
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toast styling */
    .toast {
        position: fixed; 
        top: 20px;                
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
        z-index: 1000;            
    }
    .toast.show {
        opacity: 1;
        pointer-events: auto;
    }

</style>
</head>
<body>
<div class="container">
    <h2>YouTube Burgundy - Download</h2>

    <form id="downloadForm" action="/api/download" method="post">
        <input type="text" name="link" placeholder="Enter YouTube URL" required>
        <input type="text" name="filename" placeholder="File name" required>

        <select id="playlist-dropdown" class="btn">
            <option value="" disabled selected>Select Playlist</option>
            {% for pl in playlists %}
                <option value="{{ pl }}">{{ pl }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="btn">
            Download
            <div class="spinner" id="spinner"></div>
        </button>
    </form>


    <a href="/files" class="btn">View Downloaded Files</a>
    <a href="/" class="btn">Home</a>

    <div id="toast" class="toast"></div>
</div>

<script>
const toast = document.getElementById('toast');
const spinner = document.getElementById('spinner');
const form = document.getElementById('downloadForm');
const submitButton = form.querySelector('button[type="submit"]');
const playlistDropdown = document.getElementById('playlist-dropdown');

// Temporary set to store selected playlists
const selectedPlaylists = new Set();

// Add playlist to temporary set when user selects one
playlistDropdown.addEventListener('change', () => {
    const playlist = playlistDropdown.value;
    if (playlist && !selectedPlaylists.has(playlist)) {
        selectedPlaylists.add(playlist);
        showToast(`Will add to "${playlist}" on successful download`);
    }
});

function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

form.addEventListener('submit', function(e) {
    e.preventDefault();

    const link = form.link.value;
    const filename = form.filename.value;

    if (!filename) {
        showToast("File name required");
        return;
    }

    // Show spinner and disable button
    spinner.style.display = 'inline-block';
    submitButton.disabled = true;

    const formData = new FormData(this);

    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(resp => resp.json())
    .then(async data => {
        spinner.style.display = 'none';
        submitButton.disabled = false;

        if (data.success) {
            showToast(`Download finished: ${data.filename}`);

            // Loop through selected playlists and add song
            for (const playlist of selectedPlaylists) {
                try {
                    await fetch("/playlist/add", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ playlist, file: data.filename })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            console.log(`Added ${data.filename} to ${playlist}`);
                        } else {
                            console.warn(`Failed to add to ${playlist}: ${res.message}`);
                        }
                    });
                } catch (err) {
                    console.error("Error adding to playlist:", err);
                }
            }

            // Clear temporary playlist set and form
            selectedPlaylists.clear();
            this.reset();

        } else {
            showToast(`Download failed: ${data.message}`);
        }
    })
    .catch(err => {
        spinner.style.display = 'none';
        submitButton.disabled = false;
        console.error(err);
        showToast("An error occurred during download.");
    });
});
</script>
</body>
</html>
